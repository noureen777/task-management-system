<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Task Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">ðŸ“‹ Task Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/tasks">My Tasks</a>
                    </li>
                </ul>
                <button class="btn btn-outline-light" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="mb-4">Dashboard Overview</h2>
        
        <!-- Stats Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h6 class="card-title">Total Tasks</h6>
                        <h2 id="total-tasks">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h6 class="card-title">Completed</h6>
                        <h2 id="completed-tasks">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h6 class="card-title">Pending</h6>
                        <h2 id="pending-tasks">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-danger">
                    <div class="card-body">
                        <h6 class="card-title">Overdue</h6>
                        <h2 id="overdue-tasks">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Completion Rate -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Completion Rate</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="progress-circle">
                            <h1 id="completion-rate" class="display-4 text-primary">0%</h1>
                            <p class="text-muted">Tasks Completed</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Breakdown -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Status Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Pending</span>
                                <span id="pending-count">0</span>
                            </div>
                            <div class="progress">
                                <div id="pending-bar" class="progress-bar bg-warning" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>In Progress</span>
                                <span id="progress-count">0</span>
                            </div>
                            <div class="progress">
                                <div id="progress-bar" class="progress-bar bg-info" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="d-flex justify-content-between mb-1">
                                <span>Completed</span>
                                <span id="completed-count">0</span>
                            </div>
                            <div class="progress">
                                <div id="completed-bar" class="progress-bar bg-success" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks by Category -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Tasks by Category</h5>
                    </div>
                    <div class="card-body">
                        <div id="category-chart" class="row g-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                if (response.status === 401) {
                    window.location.href = '/';
                    return;
                }
                const stats = await response.json();
                
                document.getElementById('total-tasks').textContent = stats.total_tasks;
                document.getElementById('completed-tasks').textContent = stats.completed;
                document.getElementById('pending-tasks').textContent = stats.pending;
                document.getElementById('overdue-tasks').textContent = stats.overdue;
                document.getElementById('completion-rate').textContent = stats.completion_rate + '%';
                
                // Status breakdown
                const total = stats.total_tasks || 1;
                document.getElementById('pending-count').textContent = stats.pending;
                document.getElementById('progress-count').textContent = stats.in_progress;
                document.getElementById('completed-count').textContent = stats.completed;
                
                document.getElementById('pending-bar').style.width = (stats.pending / total * 100) + '%';
                document.getElementById('progress-bar').style.width = (stats.in_progress / total * 100) + '%';
                document.getElementById('completed-bar').style.width = (stats.completed / total * 100) + '%';
                
                // Category chart
                const categoryChart = document.getElementById('category-chart');
                if (stats.tasks_by_category.length > 0) {
                    categoryChart.innerHTML = stats.tasks_by_category.map(cat => `
                        <div class="col-md-3">
                            <div class="card" style="border-left: 4px solid ${cat.color}">
                                <div class="card-body">
                                    <h6>${cat.name}</h6>
                                    <h3 class="mb-0">${cat.count}</h3>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    categoryChart.innerHTML = '<p class="text-muted">No tasks with categories yet</p>';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function logout() {
            await fetch('/api/logout', {method: 'POST'});
            window.location.href = '/';
        }

        loadStats();
    </script>
</body>
</html>